name: Update Calendar

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * *"  # æ¯å¤© 22:00 è‡ªåŠ¨è¿è¡Œ

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: ğŸ“‚ ç¡®ä¿æ•°æ®ç›®å½•å’Œæ–‡ä»¶å­˜åœ¨
        run: |
          mkdir -p data/Document
          for file in calendar.json astro.json shichen.json jieqi.json holidays.json; do
            if [ ! -f "Document/$file" ]; then
              echo "[]" > "data/Document/$file"
            fi
          done

      - name: ğŸ§‘â€ğŸ’» ç¼“å­˜ Node.js æ¨¡å—
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: âš ï¸ ç¡®ä¿ `package-lock.json` å­˜åœ¨å¹¶éç©º
        run: |
          if [ ! -f "package-lock.json" ] || [ ! -s "package-lock.json" ]; then
            echo "package-lock.json æ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©ºï¼é‡æ–°ç”Ÿæˆ..."
            npm install --package-lock-only
          else
            echo "package-lock.json å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œè·³è¿‡é‡æ–°ç”Ÿæˆã€‚"
          fi

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”„ è¿è¡Œæ•°æ®è·å–è„šæœ¬å¹¶ç”Ÿæˆ ICS æ–‡ä»¶
        run: |
          set -e
          echo "ğŸ›°ï¸ è·å–æ•°æ®..."
          node scripts/fetch-data.js
          echo "ğŸ“… ç”Ÿæˆ ICS æ–‡ä»¶..."
          node scripts/generate-ics.js

      - name: âš™ï¸ æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check_changes
        run: |
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹..."
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹"
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "æ²¡æœ‰æ›´æ”¹"
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: ğŸš€ æäº¤æ›´æ”¹
        if: env.changes == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@users.noreply.github.com"

          # æ‰§è¡Œ stash å’Œ pop ä»…åœ¨æœ‰æ›´æ”¹æ—¶
          git stash || echo "æ²¡æœ‰è¦æš‚å­˜çš„æ›´æ”¹"
          git fetch origin main
          git pull --rebase origin main
          git stash pop || echo "æ²¡æœ‰æš‚å­˜çš„æ›´æ”¹"

          git add .
          git commit -m "ğŸ”„ æ›´æ–°æ•°æ®å’Œ calendar.ics"
          git push origin main

      - name: ğŸ—ï¸ åˆ›å»º Pull Request
        if: env.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          title: "æ›´æ–°æ•°æ®å’Œ calendar.ics"
          branch: "update-calendar"
          commit-message: "æ›´æ–°æ•°æ®å’Œ calendar.ics"
          delete-branch: true
          base: main  # ç¡®ä¿ PR æ˜¯åŸºäº `main` åˆ†æ”¯çš„