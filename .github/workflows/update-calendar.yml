name: Update Calendar

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * *"  # æ¯å¤© 22:00 è‡ªåŠ¨è¿è¡Œ

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç¡®ä¿å®Œæ•´å†å²ï¼Œä¿è¯ `.ics` æ–‡ä»¶èƒ½è¢«è·Ÿè¸ª

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”„ è¿è¡Œæ•°æ®è·å–è„šæœ¬å¹¶ç”Ÿæˆ ICS æ–‡ä»¶
        run: |
          set -e
          echo "ğŸ›°ï¸ è·å–æ•°æ®..."
          node scripts/fetch-data.js
          echo "ğŸ“… ç”Ÿæˆ ICS æ–‡ä»¶..."
          node scripts/generate-ics.js

      - name: âš ï¸ ç¡®ä¿ `calendar.ics` å­˜åœ¨
        run: |
          if [ ! -f "scripts/calendar.ics" ]; then
            echo "âš ï¸ calendar.ics æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œæ£€æŸ¥ç”Ÿæˆæ˜¯å¦æˆåŠŸ"
            exit 1
          fi

      - name: âš™ï¸ æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        id: check_changes
        run: |
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹..."
          git status --porcelain
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹"
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "æ²¡æœ‰æ›´æ”¹"
            echo "changes=false" >> $GITHUB_ENV
          fi

      - name: ğŸš€ æäº¤æ›´æ”¹
        if: env.changes == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@users.noreply.github.com"

          git fetch origin main
          git pull --rebase origin main

          git add -f scripts/calendar.ics
          git commit -m "ğŸ”„ æ›´æ–°æ•°æ®å’Œ calendar.ics"
          git push origin main

      - name: ğŸ—ï¸ åˆ›å»º Pull Request
        if: env.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          title: "æ›´æ–°æ•°æ®å’Œ calendar.ics"
          branch: "update-calendar"
          commit-message: "æ›´æ–°æ•°æ®å’Œ calendar.ics"
          delete-branch: true
          base: main